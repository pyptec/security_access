C51 COMPILER V9.59.0.0   ACCESCAN                                                          11/19/2021 16:07:15 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE ACCESCAN
OBJECT MODULE PLACED IN .\Objects\Accescan.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Accescan.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Lis
                    -tings\Accescan.lst) TABS(2) OBJECT(.\Objects\Accescan.obj)

line level    source

   1          #include <Accescan.h>
   2          #include <reg51.h>
   3                    /*funciones prototipo*/
   4          extern void Block_write_clock_ascii(unsigned char *datos_clock);
   5          extern void PantallaLCD(unsigned char cod_msg);
   6          extern void Reloj_Pantalla_Lcd();
   7          extern unsigned char rx_Data(void);
   8          extern void Debug_txt_Tibbo(unsigned char * str);
   9          extern void DebugBufferMF(unsigned char *str,unsigned char num_char,char io);
  10          extern void Debug_Dividir_texto();
  11          extern void tx_aux(unsigned char caracter);
  12          extern unsigned char Dir_board();
  13          extern void Block_read_clock_ascii(unsigned char *datos_clock);
  14          extern void Two_ByteHex_Decimal(unsigned char *buffer,unsigned char id_h,unsigned char id_l);
  15          extern void ByteHex_Decimal(unsigned char *buffer,unsigned char valorhex);
  16          extern void PantallaLCD(unsigned char cod_msg);
  17          extern void LCD_txt (unsigned char * msg,char enable_char_add );
  18          extern unsigned char  ValidaSensoresPaso(void);
  19          extern void tx_aux(unsigned char caracter);
  20          extern void PantallaLCD_LINEA_2(unsigned char cod_msg, unsigned char *buffer);
  21          extern unsigned char hex_bcd (unsigned char byte);
  22          extern void Trama_pto_Paralelo_P(unsigned char *buffer_S1_B0,unsigned char *buffer_S1_B2,unsigned char cmd
             -);
  23          extern void  send_port(unsigned char *buffer_port, unsigned char length_char);
  24          extern unsigned char validar_clk(unsigned char *datos_clock);
  25          extern void graba_serie(unsigned char *buffer);
  26          extern unsigned char *Lee_No_Ticket();
  27          extern char  *strcpy  (char *s1, const char *s2);
  28          extern void Debug_chr_Tibbo(unsigned char Dat);
  29          extern void  send_port(unsigned char *buffer_port, unsigned char length_char);
  30          extern void Formato_eeprom();
  31          /*------------------------------------------------------------------------------*/
  32                /*variables externas */
  33          extern unsigned int Timer_tivo;
  34          extern unsigned char Timer_wait;
  35          extern unsigned char Tipo_Vehiculo;
  36          extern unsigned char USE_LPR;
  37          extern unsigned char  Debug_Tibbo;
  38          /*------------------------------------------------------------------------------*/
  39          /*definicion funciones*/
  40          
  41            /*bit externos*/
  42          sbit rx_ip = P0^0;        
  43          sbit lock = P1^7;           //Relevo 
  44          sbit Atascado_GP0_PIN_3 = P0^3;       //Rele de on/off del verificador o transporte
  45          sbit led_err_imp = P0^2;      //Error 
  46          sbit ready = P3^2;          //Salida. solicitud envio Datos     
  47          
  48          #define STX                     02 
  49          #define ETX                     03 
  50          /*MENSAJES PRIMARIO CON CMD DE MSJ*/
  51          
  52          
  53          #define PRMR_BIENVENIDO             0X02    //FE
C51 COMPILER V9.59.0.0   ACCESCAN                                                          11/19/2021 16:07:15 PAGE 2   

  54          #define PRMR_LOTE_FULL              0X05
  55          #define PRMR_SIN_PAGO               0XE7
  56          
  57          #define PRMR_NO_MENSUAL             0XB1
  58          #define PRMR_NO_IN_PARK             0XB2
  59          #define PRMR_IN_PARK                0XB3
  60          #define PRMR_EXPIRO                 0XB4
  61          #define PRMR_MENSUAL_FUERA_HORARIO  0XB5
  62          #define PRMR_OFF_LINE               0xB6
  63          #define PRMR_ON_LINE                0xB7
  64          #define PRMR_IN_HORARIO             0XB8
  65          #define PRMR_GRACIAS                'V'
  66          #define PRMR_BIENVENIDO_MENSUAL     'O'
  67          #define PRMR_CUPOS                  'c'
  68          #define PRMR_NOREAD_CARD            06          //0XE0
  69          
  70          #define PRMR_EXCEDE_HORARIO         0X07
  71          
  72          #define PRMR_DIREJASE_A_CAJA        0XA1
  73          #define PRMR_MENSUAL_NO_PAGO        0X08
  74          #define PRMR_UN_MOMENTO             0X09
  75          #define PRMR_SOLICITA_EVN           0XAA
  76          #define PRMR_MSJ_EXCLUSIVO          0X55
  77          /*mensaje de mensual*/
  78          #define GRACIAS                 91            //0XFF,01
  79          #define LECTURA_WIEGAND         92//0xB0
  80          #define NO_IN_PARK              93  
  81          #define EXPIRO                  94            //B4
  82          #define EXCEDE_HORARIO          95
  83          #define NO_MENSUAL_NI_PREPAGO   96
  84          #define DIREJASE_A_CAJA         90
  85          #define MENSUAL_NO_PAGO         97
  86          #define MENSUAL_FUERA_HORARIO   98
  87          #define IN_PARK                 99
  88          #define IN_HORARIO              0x9A          ///
  89          #define BIENVENIDO_WIEGAN       0x9b
  90          #define LOTE_FULL               0x9c
  91          #define CUPOS                   0x9d
  92          #define NOREAD_CARD             0x9e    
  93          /*mensaje informativo DE PANTALLAS*/
  94          #define ERROR_LOOP              170         //0XE0
  95          #define OFF_LINE                174
  96          #define UN_MOMENTO              175
  97            
  98          #define BIENVENIDO              0XFE
  99          
 100          /*direcciones de eeprom*/
 101          #define EE_USE_LPR            0x000A
 102          #define EE_DEBUG              0x0008
 103          /*define variables de esta funcion*/
 104          
 105           
 106          //unsigned char S1_B2[]={0x13, 0x03, 0x1D, 0x0B, 0x0E, 00, 00, 00, 00, 00, 0x01, 0x13, 0x03, 0x1D, 0x0E, 0
             -x1D};
 107          //unsigned char S1_B0[]={0x32, 0x31, 0x30, 0x37, 0x31, 0x35, 00, 00, 00, 00, 00, 00, 00, 00, 00, 01};
 108          //unsigned char S_B[]={0xE7, 00, 00, 00, 00, 00, 00, 00, 00, 00, 01};
 109          /*------------------------------------------------------------------------------
 110          Rutina q valida los cmd del pto paralelo
 111          temp= usado para contar 20 fuera de linea y mostralo en la pantalla
 112          ------------------------------------------------------------------------------*/
 113          void Valida_Trama_Pto(unsigned char *buffer, unsigned char length_trama)
 114          {
C51 COMPILER V9.59.0.0   ACCESCAN                                                          11/19/2021 16:07:15 PAGE 3   

 115   1        
 116   1         static unsigned char cont;
 117   1          unsigned char bcc=0;
 118   1          unsigned char j; 
 119   1          unsigned char buff[11];
 120   1        
 121   1        //USE_LPR=rd_eeprom(0xa8,EE_USE_LPR);
 122   1        /*-------------------------------CMD H reloj para el board y la pantalla lcd-----------------------------
             --------------*/
 123   1          if((length_trama==26)&&(*buffer==STX)&&(*(buffer+2)=='H')&&*(buffer+(length_trama-2))==ETX)                         
             -/*cmd de Accescan que me envia el reloj actualizado*/
 124   1          { 
 125   2            Debug_txt_Tibbo((unsigned char *) "primario BCC= ");
 126   2            Debug_chr_Tibbo(*(buffer+25));
 127   2            Debug_txt_Tibbo((unsigned char *) "\r\n");
 128   2            for (j=0; j<length_trama-1; j++)
 129   2            {
 130   3              bcc=*(buffer+j) ^ bcc;
 131   3            }
 132   2            
 133   2            Debug_txt_Tibbo((unsigned char *) "calculo BCC= ");
 134   2            Debug_chr_Tibbo(bcc);
 135   2            Debug_txt_Tibbo((unsigned char *) "\r\n");
 136   2            if (bcc == *(buffer+25))
 137   2            {
 138   3                
 139   3              if(validar_clk(buffer+3)==0)
 140   3              {
 141   4                Block_write_clock_ascii(buffer+3);                                                                                /* se escribe el reloj de h
             -ardware*/
 142   4          
 143   4                Reloj_Pantalla_Lcd();                                                                                             /* Escribo el reloj en la pantall
             -a lcd*/
 144   4            
 145   4              } 
 146   3                
 147   3                  
 148   3            }
 149   2            else
 150   2            {
 151   3              
 152   3              buff[0]=02;
 153   3              buff[1]=05;
 154   3              buff[2]=03;
 155   3              buff[3]=0;
 156   3               send_port(buff,4);
 157   3              
 158   3              Debug_txt_Tibbo((unsigned char *) "REENVIAR trama Hora: ");
 159   3              Debug_chr_Tibbo(buff[0]);
 160   3              Debug_chr_Tibbo(buff[1]);
 161   3              Debug_chr_Tibbo(buff[2]);
 162   3              Debug_txt_Tibbo((unsigned char *) "\r\n");
 163   3            }
 164   2            
 165   2            
 166   2          }
 167   1        
 168   1            /*-------------------------------CMD B1 PRMR_NO_MENSUAL_NI PREPAGO ------------------------------------
             ------------------------------*/
 169   1          else if ((*buffer==PRMR_NO_MENSUAL) )                                                                               /*ok si llega msj a;96;NO E
             -S MENSUALIDAD NI PREPAGO<LF>*/
 170   1          {
C51 COMPILER V9.59.0.0   ACCESCAN                                                          11/19/2021 16:07:15 PAGE 4   

 171   2            PantallaLCD(NO_MENSUAL_NI_PREPAGO);                                                                                           /*MSJ MENSUAL NO EN PA
             -RQUEADERO*/
 172   2          }   
 173   1            /*-------------------------------CMD B2 PRMR_NO_IN_PARK   ---------------------------------------------
             ---------------------*/
 174   1          else if ((*buffer==PRMR_NO_IN_PARK) )                                                                                 /*ok MSJ MENSUAL NO EN PAR
             -QUEADERO  */
 175   1          {
 176   2            PantallaLCD(NO_IN_PARK);                                                                                            /*MSJ MENSUAL NO EN PARQUEADERO*/
 177   2          } 
 178   1          /*-------------------------------CMD B3 PRMR_IN_PARK   -------------------------------------------------
             -----------------*/
 179   1          else if ((*buffer==PRMR_IN_PARK)  )                                                                                   /*ok msj MENSUAL ESTA EN PAR
             -QUEADER*/
 180   1          {
 181   2            PantallaLCD(IN_PARK);                                                                                           /*MSJ MENSUAL ESTA EN PARQUEADER*/
 182   2          }     
 183   1          /*-------------------------------CMD B4  EXPIRO mensualidad vencida ------------------------------------
             -----------------------*/
 184   1          else if ((length_trama==1)&&(*buffer==PRMR_EXPIRO))                                                                   /*ok msj mensual ve
             -ncida */
 185   1          {
 186   2               PantallaLCD(EXPIRO);                                                                                             /*mesualidad vencida*/
 187   2          }
 188   1          /*-------------------------------CMD B5  HORARIO mensualidad FUERA DE HORARIO --------------------------
             ---------------------------------*/
 189   1          else if ((length_trama==1)&&(*buffer==PRMR_MENSUAL_FUERA_HORARIO))                                                    /* */
 190   1          {
 191   2               PantallaLCD(MENSUAL_FUERA_HORARIO);                                                                              /*ok msj mesualidad fuera d
             -e horario*/
 192   2          }
 193   1        /*-------------------------------CMD B6 fuera de linea --------------------------------------------------
             ------------*/
 194   1          else if(*buffer==PRMR_OFF_LINE)                                                                                   /*cmd de Accescan que dice q es
             -ta fuera de linea*/
 195   1          {
 196   2              cont++;
 197   2              if (cont>4)     /* con un tiempo de retardo =((1/(22118400/12)*65535)*30)*/
 198   2              {
 199   3              PantallaLCD(OFF_LINE);
 200   3              led_err_imp=0;                                                                                                  /*error led on*/
 201   3              Timer_wait=0;
 202   3              lock=0;                                                                                                         /*relevo off despues de 1 minuto*/
 203   3              Atascado_GP0_PIN_3 = 0; 
 204   3              cont=0;
 205   3              }
 206   2          }
 207   1          /*-------------------------------CMD B7 en linea (AA) NO SE SABE  --------------------------------------
             -----------------------------*/
 208   1          else if ((*buffer==PRMR_ON_LINE)  ||(*buffer==PRMR_SOLICITA_EVN) )                                                                              
             -      /*en linea*/
 209   1          {   
 210   2            
 211   2            if (Timer_wait>=20)                                                                                               /* se envia el msj fuera de linea*/
 212   2            { 
 213   3              Timer_wait=0;                                                                                                   /*se inicia el timer*/
 214   3              lock=0;
 215   3              led_err_imp=1;                                                                                                  /*relevo off despues de 1 minuto*/
 216   3              Atascado_GP0_PIN_3 = 0; 
 217   3            } 
 218   2            
 219   2            if ((Debug_Tibbo==0)&&(USE_LPR==1)&& (Timer_tivo>=600))
C51 COMPILER V9.59.0.0   ACCESCAN                                                          11/19/2021 16:07:15 PAGE 5   

 220   2            {
 221   3              Timer_tivo=0;
 222   3              Debug_Tibbo=1;
 223   3              Debug_txt_Tibbo((unsigned char *) "LIVE");
 224   3              Debug_Tibbo=0;
 225   3            }
 226   2            
 227   2            
 228   2          } 
 229   1        /*-------------------------------CMD B8  IN_HORARIO  mensualidad vencida --------------------------------
             ---------------------------*/
 230   1          else if ((length_trama==1)&&(*buffer==PRMR_IN_HORARIO))                                                                   /* */
 231   1          {
 232   2               PantallaLCD(IN_HORARIO);                                                                                             /*mesualidad vencida*/
 233   2          } 
 234   1              /*------------------------------- CMD 55 PRMR_MSJ_EXCLUSIVO  -----------------------------------------
             --------------------------*/
 235   1          else if ((length_trama==3)&&(*(buffer+1)==PRMR_MSJ_EXCLUSIVO)&&*(buffer+(length_trama-1))==ETX)                 
             -                                                      /* */
 236   1          {
 237   2               Formato_eeprom();                                                                                            /*mesualidad vencida*/
 238   2          } 
 239   1            /*-------------------------------CMD A1    DIREJASE_A_CAJA                ------------------------------
             -------------------------------------*/
 240   1          else if ((length_trama==1)&&(*buffer==PRMR_DIREJASE_A_CAJA  ))                                                                        /*cmd 0
             -xA1 audio caja que es igual a no registra pago */
 241   1          {
 242   2               PantallaLCD(DIREJASE_A_CAJA);
 243   2          }
 244   1          /*-------------------------------CMD 05  Lote full   ---------------------------------------------------
             ----------------*/
 245   1          else if ((length_trama==1)&&(*buffer==PRMR_LOTE_FULL))                                                                    /*lote de carros
             - full */
 246   1          {
 247   2               PantallaLCD(LOTE_FULL);
 248   2          }
 249   1            /*-------------------------------CMD 06   ACERQUE SU TARJETA DE NUEVO  --------------------------------
             -----------------------------------*/
 250   1          else if ((length_trama==1)&&(*buffer == PRMR_NOREAD_CARD  ))                                                                    /*cmd 0xA1 
             -audio caja que es igual a no registra pago */
 251   1          {
 252   2               PantallaLCD(NOREAD_CARD); //arregal ERROR_LOOP
 253   2          }
 254   1          
 255   1              /*-------------------------------CMD 07  EXCEDE_HORARIO   --------------------------------------------
             -----------------------*/
 256   1          else if ((length_trama==1)&&(*buffer==PRMR_EXCEDE_HORARIO))                                                                   /*cmd 0xA1 
             -audio caja que es igual a no registra pago */
 257   1          {
 258   2               PantallaLCD(EXCEDE_HORARIO);
 259   2          }
 260   1          
 261   1      
 262   1              /*-------------------------------CMD 08 MENSUAL_NO_PAGO   --------------------------------------------
             -----------------------*/
 263   1          else if ((length_trama == 1)&&(*buffer==PRMR_MENSUAL_NO_PAGO))                                                                    /*cmd 0x
             -A1 audio caja que es igual a no registra pago */
 264   1          {
 265   2               PantallaLCD(MENSUAL_NO_PAGO);
 266   2          } 
 267   1        
 268   1          /*-------------------------------CMD 09 UN_MOMENTO     --------------------------------------------------
C51 COMPILER V9.59.0.0   ACCESCAN                                                          11/19/2021 16:07:15 PAGE 6   

             -----------------*/
 269   1          else if ((length_trama == 1)&&(*buffer==PRMR_UN_MOMENTO ))                                                                    /*cmd 0xA1 a
             -udio caja que es igual a no registra pago */
 270   1          {
 271   2               PantallaLCD(UN_MOMENTO );
 272   2          }     
 273   1        
 274   1          /*-------------------------------CMD 'V'=PRMR_GRACIAS  msj Gracias y nombre del mensual-----------------
             -------------------------*/
 275   1          else if ((length_trama == 0x13)&& (*(buffer+1)==PRMR_GRACIAS)&&*(buffer+(length_trama-1))==ETX)                 
             -        /* */
 276   1          {
 277   2               *(buffer+(length_trama-1))=0;
 278   2               PantallaLCD_LINEA_2(GRACIAS,buffer+2);                                                                     /*SE ENVIA EL MSJ GRACIAS lo
             - q envia el software*/
 279   2          }
 280   1          
 281   1          /*-------------------------------CMD 'O'=PRMR_BIENVENIDO  msj BIENVENIDO  nombre del mensual------------
             ------------------------------*/
 282   1          else if ((length_trama == 0x13)&& (*(buffer+1) == PRMR_BIENVENIDO_MENSUAL)&&*(buffer+(length_trama-1))==
             -ETX)                          /* */
 283   1          {
 284   2             //Debug_txt_Tibbo(buffer+1);
 285   2              *(buffer+(length_trama-1))=0;
 286   2               PantallaLCD_LINEA_2(BIENVENIDO_WIEGAN,buffer+2);                                                                     /*SE ENVIA EL MSJ 
             -GRACIAS lo q envia el software*/
 287   2          }
 288   1          
 289   1          /*-------------------------------CMD de wiegand---------------------------------------------------*/
 290   1          else if ((length_trama==6)&&(*buffer==STX)&&(*(buffer+1)=='W')&&*(buffer+(length_trama-1))==ETX)                
             -    /* cmd q comunica con monitor por wiegand*/
 291   1          {
 292   2              /*-------------------------------se covierte el numero serie de la tarjeta----------------------------
             ---*/
 293   2                    ByteHex_Decimal(buff,*(buffer+2));                                                                        /*convierto el primer byte_he
             -x a decimal    */
 294   2                    buff[3]=' ';
 295   2                    Two_ByteHex_Decimal(buff+4,*(buffer+3),*(buffer+4)) ;                                                     /*convierto un byte
             - de 16 bits a decimal*/   
 296   2              /*----------------------------------------------------------------------------------------------------
             ---*/
 297   2                
 298   2            if (USE_LPR==1)
 299   2              {
 300   3                    /*-------------------------------mensaje en la pantalla -------------------------------------------
             --*/
 301   3                    /*ValidaSensoresPaso=0 no hay presencia  ValidaSensoresPaso=0xff  hay presencia*/
 302   3                    if (ValidaSensoresPaso()!= 0xff)
 303   3                    {               
 304   4                      PantallaLCD(ERROR_LOOP);
 305   4                      PantallaLCD_LINEA_2(LECTURA_WIEGAND,buff);                                                                /*msj rasberry*/
 306   4                    }
 307   3                    else
 308   3                    {
 309   4                      Cmd_LPR_Salida_wiegand(buff);
 310   4                      PantallaLCD_LINEA_2(LECTURA_WIEGAND,buff);                                                                /*msj rasberry*/
 311   4                    }
 312   3                
 313   3                                                                                                                              /*transmito el codigo de la tarjeta a la panta
             -lla lcd*/
 314   3                                
 315   3              }                                                                             
C51 COMPILER V9.59.0.0   ACCESCAN                                                          11/19/2021 16:07:15 PAGE 7   

 316   2              
 317   2              else
 318   2              {
 319   3                 /*-------------------------------mensaje en la pantalla---------------------------------------------
             -------*/
 320   3                      /*modificacion 26/03/2021*/                                             
 321   3                    //if (ValidaSensoresPaso()!= 0xff)
 322   3                    //{               
 323   3                    //  PantallaLCD(ERROR_LOOP);
 324   3                    //}
 325   3                //posible falla
 326   3                    PantallaLCD_LINEA_2(LECTURA_WIEGAND,buff);                                                                /*transmito el codigo de 
             -la tarjeta a la pantalla lcd*/
 327   3                                                                                                          
 328   3                /*---------------------------------------------------------------------------------------------------
             ------*/  
 329   3              
 330   3              }
 331   2          }
 332   1          /*-------------------------------CMD 'c' =PRMR_cupos -----------------------------------------*/
 333   1          else if  ((length_trama == 7) && (*buffer == STX)&&(*(buffer+1) == PRMR_CUPOS )&& *(buffer+(length_trama
             --1)) == ETX)  
 334   1          {
 335   2              *(buffer+(length_trama-1))=0;
 336   2               PantallaLCD_LINEA_2(CUPOS,buffer+2);   
 337   2          }
 338   1          /*numero de serie del ticket 02 , No serie 10dig,  03*/
 339   1          else if ((length_trama==12)&&(*buffer==STX)&&*(buffer+(length_trama-1))==ETX)
 340   1          {
 341   2            graba_serie(buffer+1);                                                                                          /*graba el No de concecutivo  en eep
             -rom*/
 342   2                
 343   2          }
 344   1          
 345   1      }
 346          /*------------------------------------------------------------------------------*/
 347          /*
 348          #define STX                     02 
 349          #define ETX                     03 
 350          #define FUERA_DE_LINEA          0xb6
 351          #define ON_LINE                 0xAA
 352          
 353          /*mensajes de pantalla*/
 354          /*
 355          #define BIENVENIDO              0XFE
 356          #define SIN_PAGO                0XE7
 357          #define LECTURA_DE_TARJETAS     0xB0
 358          
 359          /*tipo de vehiculo*/
 360          /*
 361          #define AUTOMOVIL           0X00
 362          #define MOTO                0X01
 363          
 364          //unsigned char S1_B2[]={0x13, 0x03, 0x1D, 0x0B, 0x0E, 00, 00, 00, 00, 00, 0x01, 0x13, 0x03, 0x1D, 0x0E, 0
             -x1D};
 365          //unsigned char S1_B0[]={0x32, 0x31, 0x30, 0x37, 0x31, 0x35, 00, 00, 00, 00, 00, 00, 00, 00, 00, 01};
 366          //unsigned char S_B[]={0xE7, 00, 00, 00, 00, 00, 00, 00, 00, 00, 01};
 367          /*------------------------------------------------------------------------------
 368          Rutina q valida los cmd del pto paralelo
 369          recibe el buffer de los datos
 370          length_trama= longitud de la trama
 371          ------------------------------------------------------------------------------*/
C51 COMPILER V9.59.0.0   ACCESCAN                                                          11/19/2021 16:07:15 PAGE 8   

 372          /*
 373          void Valida_Trama_Pto(unsigned char *buffer, unsigned char length_trama)
 374          {
 375             unsigned char buff[11];
 376            /*-------------------------------CMD H reloj para el board y la pantalla lcd-----------------------------
             --------------*/
 377            //  if((length_trama==25)&&(*buffer==STX)&&(*(buffer+2)=='H')&&*(buffer+(length_trama-1))==ETX)                     
             -    /*cmd de Accescan que me envia el reloj actualizado*/
 378            //  { 
 379            //    if(validar_clk(buffer+3)==0)
 380            //    {
 381            //    Block_write_clock_ascii(buffer+3);                                                                                /* se escribe el reloj de h
             -ardware*/
 382              
 383            //    Reloj_Pantalla_Lcd();                                                                                             /* Escribo el reloj actual  en la
             - pantalla lcd*/
 384              
 385            //    }   
 386            //  }
 387              /*-------------------------------CMD B6 fuera de linea -------------------------------------------------
             -------------*/
 388            //  else if(*buffer==FUERA_DE_LINEA)                                                                                    /*cmd de Accescan que dice q
             - esta fuera de linea*/
 389            //  {
 390            //    if (Timer_wait>=20)                                                                                               /* se envia el msj fuera de linea*
             -/
 391            //    {                                                                                                                 /* con un tiempo de retardo =((1/(22118400/
             -12)*65535)*30)*/
 392            //      PantallaLCD(FUERA_DE_LINEA);
 393            //      led_err_imp=0;                                                                                                  /*error led on*/
 394            //      //Timer_wait=0;
 395              //    lock=0;                                                                                                         /*relevo off despues de 1 minuto*/
 396              //    Atascado=0; 
 397            //    }
 398            //  }
 399              /*-------------------------------CMD AA en linea -------------------------------------------------------
             ------------*/
 400            //  else if ((*buffer==ON_LINE) )                                                                                       /*en linea*/
 401            //  {
 402                
 403            //    if (Timer_wait>=20)                                                                                               /* se envia el msj fuera de linea*
             -/
 404            //    { 
 405          //        Timer_wait=0;                                                                                                   /*se inicia el timer*/
 406          //        lock=0;
 407          //        led_err_imp=1;                                                                                                  /*relevo off despues de 1 minuto*/
 408          //        Atascado=0; 
 409          //      } 
 410                
 411          //      if ((Debug_Tibbo==0)&&(USE_LPR==1)&& (Timer_tivo>=600))
 412          //      {
 413          //        Timer_tivo=0;
 414          //        Debug_Tibbo=1;
 415            //      Debug_txt_Tibbo((unsigned char *) "LIVE");
 416          //        Debug_Tibbo=0;
 417          //      }
 418                
 419                
 420          //    } 
 421          
 422              
 423          
C51 COMPILER V9.59.0.0   ACCESCAN                                                          11/19/2021 16:07:15 PAGE 9   

 424          //    else if ((length_trama==19)&&(*buffer==STX)&&(*(buffer+1)=='O')&&*(buffer+(length_trama-1))==ETX)         
             -          /*mensaje de bienvenidos*/
 425          //    {
 426           //     PantallaLCD(BIENVENIDO);
 427            //  }
 428            //  else if ((length_trama==1)&&(*buffer==0xA1))                                                                        /*cmd 0xA1 audio caja 
             -que es igual a no registra pago */
 429            //  {
 430            //       PantallaLCD(SIN_PAGO);
 431            //  }
 432                        /*-------------------------------CMD de wiegand---------------------------------------------------*
             -/
 433          //    else if ((length_trama==6)&&(*buffer==STX)&&(*(buffer+1)=='W')&&*(buffer+(length_trama-1))==ETX)            
             -        /* cmd q comunica con monitor po wigan*/
 434          //    {
 435          //        if (USE_LPR==1)
 436          //        {
 437                        /*-------------------------------mensaje en la pantalla--------------------------------------------
             --------*/
 438            //            ByteHex_Decimal(buff,*(buffer+2));                                                                        /*convierto el primer byte_
             -hex a decimal    */
 439              //          buff[3]=' ';
 440              //          Two_ByteHex_Decimal(buff+4,*(buffer+3),*(buffer+4)) ;                                                     /*convierto un by
             -te de 16 bits a decimal*/                                                 
 441                      
 442              //          PantallaLCD_LINEA_2(LECTURA_DE_TARJETAS,buff);
 443                                                                                                                                  /*transmito el codigo de la tarjeta a la panta
             -lla lcd*/
 444                        /*-------------------------------------------------------------------------------------------------
             --------*/
 445                    
 446                //        while(!ValidaSensoresPaso());
 447                          
 448              //          Cmd_LPR_Salida_wiegand(buff);
 449              //    }                                                                             
 450                  
 451              //    else
 452              //    {
 453                     /*-------------------------------mensaje en la pantalla---------------------------------------------
             -------*/
 454              //          ByteHex_Decimal(buff,*(buffer+2));                                                                        /*convierto el primer byte_
             -hex a decimal    */
 455              //          buff[3]=' ';
 456              //          Two_ByteHex_Decimal(buff+4,*(buffer+3),*(buffer+4)) ;                                                     /*convierto un by
             -te de 16 bits a decimal*/                                                 
 457              //          PantallaLCD_LINEA_2(LECTURA_DE_TARJETAS,buff);                                                            /*transmito el codigo
             - de la tarjeta a la pantalla lcd*/
 458                                                                                                              
 459                    /*---------------------------------------------------------------------------------------------------
             ------*/  
 460                  
 461              //    }
 462            //  }
 463              /*numero de serie del ticket 02 , No serie 10dig,  03*/
 464            //  else if ((length_trama==12)&&(*buffer==STX)&&*(buffer+(length_trama-1))==ETX)
 465            //  {
 466            //    graba_serie(buffer+1);                                                                                          /*graba el No de concecutivo  en e
             -eprom*/
 467                    
 468            //  }
 469          //}
 470          
C51 COMPILER V9.59.0.0   ACCESCAN                                                          11/19/2021 16:07:15 PAGE 10  

 471          /*------------------------------------------------------------------------------
 472          Rutina q valida los cmd de Monitor
 473          ------------------------------------------------------------------------------*/
 474          /*
 475          void Valida_Trama_Monitor(unsigned char *buffer, unsigned char length_trama)
 476          {   
 477            length_trama=1;
 478              if  ((*(buffer+2)==ETX)&&(*(buffer+1)=='P'))                                                                            /* APERTURA DE BARRETA
             -*/ 
 479          /*        {
 480                    lock=1;                                                                                                           /*habilita el relevo ON*/
 481          //          Timer_wait=0;
 482          //        }
 483          //    else if (*buffer=='<')
 484          //    {                                                                                                                       /*placa*/
 485          //    }
 486          //}
 487          /*------------------------------------------------------------------------------
 488          
 489          ------------------------------------------------------------------------------*/
 490          /*
 491          void Cmd_Monitor()
 492          {
 493              
 494            
 495          }
 496          */
 497          /*------------------------------------------------------------------------------
 498          Transmito un caracter al software monitor 
 499          ------------------------------------------------------------------------------*/
 500          void Monitor_chr (unsigned char *str,unsigned char num_char)
 501          {
 502   1        unsigned char j;
 503   1        for (j=0; j<num_char; j++)
 504   1          {
 505   2          tx_aux(*str);
 506   2          str++;
 507   2          }
 508   1      }
 509            
 510          /*------------------------------------------------------------------------------
 511          Transmito CMD de salida wiegand 
 512          ------------------------------------------------------------------------------*/
 513          void Cmd_LPR_Salida_wiegand(unsigned char *buffer)
 514          {
 515   1        unsigned char Buffer_Lpr[30];
 516   1        unsigned char j=3;
 517   1        Buffer_Lpr[0]=STX;                                      /*inicio de cmd STx*/
 518   1        Buffer_Lpr[1]=Dir_board();                              /*direccion de la tarjeta*/
 519   1        Buffer_Lpr[2]='S';                                      /*cmd S que salida wiegand*/
 520   1        if(Tipo_Vehiculo!=0)                                    /*Tipo de vehiculo*/
 521   1          {
 522   2            Buffer_Lpr[j++]='M';                                /*moto*/
 523   2          }
 524   1          else
 525   1          {
 526   2            Buffer_Lpr[j++]='C';                                /*carro*/
 527   2          }
 528   1        
 529   1          
 530   1          
 531   1          for (j=4; *buffer != '\0'; j++)                       /*numero del tab o tarjeta Mf*/
C51 COMPILER V9.59.0.0   ACCESCAN                                                          11/19/2021 16:07:15 PAGE 11  

 532   1            {
 533   2                Buffer_Lpr[j]=*buffer;
 534   2                buffer++;
 535   2              
 536   2            }
 537   1            Buffer_Lpr[j++]=':';                                /*separador del tab  o tarjeta MF*/
 538   1                        
 539   1            Block_read_clock_ascii(Buffer_Lpr+j);               /*año,mes,dia,hora,minutos,*/
 540   1            Buffer_Lpr[j+10]=':';                               /*separador fecha*/
 541   1            Buffer_Lpr[j+11]=ETX;                               /*fin de la trama*/
 542   1          
 543   1                
 544   1          
 545   1            Monitor_chr(Buffer_Lpr,j+12);                       /*rutina de envio de la trama a monitor*/
 546   1      }
 547          /*
 548          unsigned char Calculo_bcc(unsigned char *buffer, unsigned char leng_trama)
 549          {
 550            unsigned char bcc=0;
 551            unsigned char j;
 552            
 553            for (j=0; j<leng_trama; j++)
 554            {
 555                  bcc=*(buffer+j) ^ bcc;
 556            }
 557            return bcc;
 558          }
 559          */
 560          /*------------------------------------------------------------------------------
 561          
 562          ------------------------------------------------------------------------------*/
 563          //void Cmd_LPR_Salida(unsigned char *buffer_S1_B0,unsigned char *buffer_S1_B2)
 564          //{
 565            
 566            
 567          //  unsigned char Buffer_Lpr[30];
 568          //  unsigned temp;
 569          //  unsigned char j=3;
 570          //  Buffer_Lpr[0]=STX;                                /*inicio de cmd STx*/
 571          //  Buffer_Lpr[1]=Dir_board();                        /*direccion de la tarjeta*/
 572          //  Buffer_Lpr[2]='S';                                /*numero de digitos de transmicion NO IMPORTA NO ES VALIDADO EN PRINC
             -IPAL*/
 573            
 574          //    if(*(buffer_S1_B2+8)!=0)                        /*Tipo de vehiculo*/
 575          //    {
 576            //    Buffer_Lpr[j++]='M';                          /*moto*/
 577            //  }
 578            //  else
 579            //  {
 580            //    Buffer_Lpr[j++]='C';                          /*carro*/
 581            //  }
 582            
 583            
 584          //  do
 585            //{
 586            // Buffer_Lpr[j++]=*buffer_S1_B0;                 /*ticket o consecutivo*/
 587            //  buffer_S1_B0++;
 588            //}while (*buffer_S1_B0!=0);
 589            
 590            
 591            
 592            
C51 COMPILER V9.59.0.0   ACCESCAN                                                          11/19/2021 16:07:15 PAGE 12  

 593            
 594              //Buffer_Lpr[j++]=':';                            /*separador de la fecha de entrada*/
 595          
 596            //  temp=hex_bcd(*(buffer_S1_B2+0));                /*año a ascii*/
 597            //  Buffer_Lpr[j++]=((temp & 0xf0)>>4)| 0x30;
 598            //  Buffer_Lpr[j++]=((temp & 0x0f))| 0x30;
 599              
 600            //  temp=hex_bcd(*(buffer_S1_B2+1));                /*mes a ascii*/
 601            //  Buffer_Lpr[j++]=((temp & 0xf0)>>4)| 0x30;
 602            //  Buffer_Lpr[j++]=((temp & 0x0f))| 0x30;
 603            
 604            //  temp=hex_bcd(*(buffer_S1_B2+2));                /*Dia a ascii*/
 605            //  Buffer_Lpr[j++]=((temp & 0xf0)>>4)| 0x30;
 606            //  Buffer_Lpr[j++]=((temp & 0x0f))| 0x30;
 607            
 608            //  temp=hex_bcd(*(buffer_S1_B2+3));                /*Hora a ascii*/
 609            //  Buffer_Lpr[j++]=((temp & 0xf0)>>4)| 0x30;
 610            //  Buffer_Lpr[j++]=((temp & 0x0f))| 0x30;
 611            
 612            //  temp=hex_bcd(*(buffer_S1_B2+4));                /*Minutos a ascii*/
 613            //  Buffer_Lpr[j++]=((temp & 0xf0)>>4)| 0x30;
 614            //  Buffer_Lpr[j++]=((temp & 0x0f))| 0x30;
 615            
 616              
 617            
 618            //  Buffer_Lpr[j++]=':';                            /*separador tipo fecha*/
 619                                                              /**/
 620                  
 621            //  Buffer_Lpr[j++]=ETX;  
 622            
 623            //  Monitor_chr(Buffer_Lpr,j);                        /*rutina de envio de la trama a monitor*/
 624          //}
 625          //void Cmd_Lpr_Int()
 626          //{
 627          //  unsigned char Buffer_Lpr[30];
 628          //  unsigned char j=3;
 629          //  unsigned char *ticket;/
 630          //  Buffer_Lpr[0]=STX;                                /*inicio de cmd STx*/
 631          //  Buffer_Lpr[1]=Dir_board();                        /*direccion de la tarjeta*/
 632          //  Buffer_Lpr[2]='E';                                /*numero de digitos de transmicion NO IMPORTA NO ES VALIDADO EN PRINC
             -IPAL*/
 633          //  if (Tipo_Vehiculo==AUTOMOVIL)         //cambio del vehiculo
 634          //  {
 635          //    Buffer_Lpr[3]='C';
 636          //    Buffer_Lpr[4]=0;
 637          //  }
 638          //  else
 639          //    {
 640          //      Buffer_Lpr[3]=('M');
 641          //      Buffer_Lpr[4]=0;
 642          //    }
 643          //    
 644          //  ticket=Lee_No_Ticket();
 645          //  strcpy( Buffer_Lpr,ticket);
 646          //}
 647          
 648            


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1624    ----
   CONSTANT SIZE    =     59    ----
C51 COMPILER V9.59.0.0   ACCESCAN                                                          11/19/2021 16:07:15 PAGE 13  

   XDATA SIZE       =      1      55
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
