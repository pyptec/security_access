C51 COMPILER V9.59.0.0   ACCESCAN                                                          06/08/2021 15:03:36 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE ACCESCAN
OBJECT MODULE PLACED IN .\Objects\Accescan.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Accescan.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Lis
                    -tings\Accescan.lst) TABS(2) OBJECT(.\Objects\Accescan.obj)

line level    source

   1          #include <Accescan.h>
   2          #include <reg51.h>
   3                    /*funciones prototipo*/
   4          extern void Block_write_clock_ascii(unsigned char *datos_clock);
   5          extern void PantallaLCD(unsigned char cod_msg);
   6          extern void Reloj_Pantalla_Lcd();
   7          extern unsigned char rx_Data(void);
   8          extern void Debug_txt_Tibbo(unsigned char * str);
   9          extern void DebugBufferMF(unsigned char *str,unsigned char num_char,char io);
  10          extern void Debug_Dividir_texto();
  11          extern void tx_aux(unsigned char caracter);
  12          extern unsigned char Dir_board();
  13          extern void Block_read_clock_ascii(unsigned char *datos_clock);
  14          extern void Two_ByteHex_Decimal(unsigned char *buffer,unsigned char id_h,unsigned char id_l);
  15          extern void ByteHex_Decimal(unsigned char *buffer,unsigned char valorhex);
  16          extern void PantallaLCD(unsigned char cod_msg);
  17          extern void LCD_txt (unsigned char * msg,char enable_char_add );
  18          extern unsigned char  ValidaSensoresPaso(void);
  19          extern void tx_aux(unsigned char caracter);
  20          extern void PantallaLCD_LINEA_2(unsigned char cod_msg, unsigned char *buffer);
  21          extern unsigned char hex_bcd (unsigned char byte);
  22          extern void Trama_pto_Paralelo_P(unsigned char *buffer_S1_B0,unsigned char *buffer_S1_B2,unsigned char cmd
             -);
  23          extern void  send_port(unsigned char *buffer_port, unsigned char length_char);
  24          extern unsigned char validar_clk(unsigned char *datos_clock);
  25          extern void graba_serie(unsigned char *buffer);
  26          extern unsigned char *Lee_No_Ticket();
  27          extern char  *strcpy  (char *s1, const char *s2);
  28          extern void Debug_chr_Tibbo(unsigned char Dat);
  29          extern void  send_port(unsigned char *buffer_port, unsigned char length_char);
  30          /*------------------------------------------------------------------------------*/
  31                /*variables externas */
  32          extern unsigned int Timer_tivo;
  33          extern unsigned char Timer_wait;
  34          extern unsigned char Tipo_Vehiculo;
  35          extern unsigned char USE_LPR;
  36          extern unsigned char  Debug_Tibbo;
  37          /*------------------------------------------------------------------------------*/
  38          /*definicion funciones*/
  39          
  40            /*bit externos*/
  41          sbit rx_ip = P0^0;        
  42          sbit lock = P1^7;           //Relevo 
  43          sbit Atascado_GP0_PIN_3 = P0^3;       //Rele de on/off del verificador o transporte
  44          sbit led_err_imp = P0^2;      //Error 
  45          sbit ready = P3^2;          //Salida. solicitud envio Datos     
  46          
  47          #define STX                     02 
  48          #define ETX                     03 
  49          /*MENSAJES PRIMARIO CON CMD DE MSJ*/
  50          
  51          
  52          #define PRMR_BIENVENIDO             0X02    //FE
  53          #define PRMR_LOTE_FULL              0X05
C51 COMPILER V9.59.0.0   ACCESCAN                                                          06/08/2021 15:03:36 PAGE 2   

  54          #define PRMR_SIN_PAGO               0XE7
  55          
  56          #define PRMR_NO_MENSUAL             0XB1
  57          #define PRMR_NO_IN_PARK             0XB2
  58          #define PRMR_IN_PARK                0XB3
  59          #define PRMR_EXPIRO                 0XB4
  60          #define PRMR_MENSUAL_FUERA_HORARIO  0XB5
  61          #define PRMR_OFF_LINE               0xB6
  62          #define PRMR_ON_LINE                0xB7
  63          #define PRMR_IN_HORARIO             0XB8
  64          #define PRMR_GRACIAS                'V'
  65          #define PRMR_BIENVENIDO_MENSUAL     'O'
  66          #define PRMR_CUPOS                  'c'
  67          #define PRMR_NOREAD_CARD            06          //0XE0
  68          
  69          #define PRMR_EXCEDE_HORARIO         0X07
  70          
  71          #define PRMR_DIREJASE_A_CAJA        0XA1
  72          #define PRMR_MENSUAL_NO_PAGO        0X08
  73          #define PRMR_UN_MOMENTO             0X09
  74          #define PRMR_SOLICITA_EVN           0XAA
  75          /*mensaje de mensual*/
  76          #define GRACIAS                 91            //0XFF,01
  77          #define LECTURA_WIEGAND         92//0xB0
  78          #define NO_IN_PARK              93  
  79          #define EXPIRO                  94            //B4
  80          #define EXCEDE_HORARIO          95
  81          #define NO_MENSUAL_NI_PREPAGO   96
  82          #define DIREJASE_A_CAJA         90
  83          #define MENSUAL_NO_PAGO         97
  84          #define MENSUAL_FUERA_HORARIO   98
  85          #define IN_PARK                 99
  86          #define IN_HORARIO              0x9A          ///
  87          #define BIENVENIDO_WIEGAN       0x9b
  88          #define LOTE_FULL               0x9c
  89          #define CUPOS                   0x9d
  90          #define NOREAD_CARD             0x9e    
  91          /*mensaje informativo DE PANTALLAS*/
  92          #define ERROR_LOOP              170         //0XE0
  93          #define OFF_LINE                174
  94          #define UN_MOMENTO              175
  95            
  96          #define BIENVENIDO              0XFE
  97          
  98          /*direcciones de eeprom*/
  99          #define EE_USE_LPR            0x000A
 100          #define EE_DEBUG              0x0008
 101          /*define variables de esta funcion*/
 102          
 103           
 104          //unsigned char S1_B2[]={0x13, 0x03, 0x1D, 0x0B, 0x0E, 00, 00, 00, 00, 00, 0x01, 0x13, 0x03, 0x1D, 0x0E, 0
             -x1D};
 105          //unsigned char S1_B0[]={0x32, 0x31, 0x30, 0x37, 0x31, 0x35, 00, 00, 00, 00, 00, 00, 00, 00, 00, 01};
 106          //unsigned char S_B[]={0xE7, 00, 00, 00, 00, 00, 00, 00, 00, 00, 01};
 107          /*------------------------------------------------------------------------------
 108          Rutina q valida los cmd del pto paralelo
 109          temp= usado para contar 20 fuera de linea y mostralo en la pantalla
 110          ------------------------------------------------------------------------------*/
 111          void Valida_Trama_Pto(unsigned char *buffer, unsigned char length_trama)
 112          {
 113   1        
 114   1         static unsigned char cont;
C51 COMPILER V9.59.0.0   ACCESCAN                                                          06/08/2021 15:03:36 PAGE 3   

 115   1          unsigned char bcc=0;
 116   1          unsigned char buff[11];
 117   1          unsigned char buffer_port[4];
 118   1        //USE_LPR=rd_eeprom(0xa8,EE_USE_LPR);
 119   1        /*-------------------------------CMD H reloj para el board y la pantalla lcd-----------------------------
             --------------*/
 120   1          if((length_trama==26)&&(*buffer==STX)&&(*(buffer+2)=='H')&&*(buffer+(length_trama-2))==ETX)                         
             -/*cmd de Accescan que me envia el reloj actualizado*/
 121   1          { 
 122   2            Debug_txt_Tibbo((unsigned char *) "primario BCC= ");
 123   2            Debug_chr_Tibbo(*(buffer+25));
 124   2            Debug_txt_Tibbo((unsigned char *) "\r\n");
 125   2            bcc=Calculo_bcc(buffer,length_trama-1);
 126   2            Debug_txt_Tibbo((unsigned char *) "calculo BCC= ");
 127   2            Debug_chr_Tibbo(bcc);
 128   2            Debug_txt_Tibbo((unsigned char *) "\r\n");
 129   2            if (bcc == *(buffer+25))
 130   2            {
 131   3                
 132   3              if(validar_clk(buffer+3)==0)
 133   3              {
 134   4                Block_write_clock_ascii(buffer+3);                                                                                /* se escribe el reloj de h
             -ardware*/
 135   4          
 136   4                Reloj_Pantalla_Lcd();                                                                                             /* Escribo el reloj en la pantall
             -a lcd*/
 137   4            
 138   4              } 
 139   3                
 140   3                  
 141   3            }
 142   2            else
 143   2            {
 144   3              
 145   3              buffer_port[0]=02;
 146   3              buffer_port[1]=05;
 147   3              buffer_port[2]=03;
 148   3              buffer_port[3]=0;
 149   3               send_port(buffer_port,4);
 150   3              
 151   3              Debug_txt_Tibbo((unsigned char *) "REENVIAR trama Hora: ");
 152   3              Debug_chr_Tibbo(buffer_port[0]);
 153   3              Debug_chr_Tibbo(buffer_port[1]);
 154   3              Debug_chr_Tibbo(buffer_port[2]);
 155   3              Debug_txt_Tibbo((unsigned char *) "\r\n");
 156   3            }
 157   2            
 158   2            
 159   2          }
 160   1        
 161   1            /*-------------------------------CMD B1 PRMR_NO_MENSUAL_NI PREPAGO ------------------------------------
             ------------------------------*/
 162   1          else if ((*buffer==PRMR_NO_MENSUAL) )                                                                               /*ok si llega msj a;96;NO E
             -S MENSUALIDAD NI PREPAGO<LF>*/
 163   1          {
 164   2            PantallaLCD(NO_MENSUAL_NI_PREPAGO);                                                                                           /*MSJ MENSUAL NO EN PA
             -RQUEADERO*/
 165   2          }   
 166   1            /*-------------------------------CMD B2 PRMR_NO_IN_PARK   ---------------------------------------------
             ---------------------*/
 167   1          else if ((*buffer==PRMR_NO_IN_PARK) )                                                                                 /*ok MSJ MENSUAL NO EN PAR
             -QUEADERO  */
C51 COMPILER V9.59.0.0   ACCESCAN                                                          06/08/2021 15:03:36 PAGE 4   

 168   1          {
 169   2            PantallaLCD(NO_IN_PARK);                                                                                            /*MSJ MENSUAL NO EN PARQUEADERO*/
 170   2          } 
 171   1          /*-------------------------------CMD B3 PRMR_IN_PARK   -------------------------------------------------
             -----------------*/
 172   1          else if ((*buffer==PRMR_IN_PARK)  )                                                                                   /*ok msj MENSUAL ESTA EN PAR
             -QUEADER*/
 173   1          {
 174   2            PantallaLCD(IN_PARK);                                                                                           /*MSJ MENSUAL ESTA EN PARQUEADER*/
 175   2          }     
 176   1          /*-------------------------------CMD B4  EXPIRO mensualidad vencida ------------------------------------
             -----------------------*/
 177   1          else if ((length_trama==1)&&(*buffer==PRMR_EXPIRO))                                                                   /*ok msj mensual ve
             -ncida */
 178   1          {
 179   2               PantallaLCD(EXPIRO);                                                                                             /*mesualidad vencida*/
 180   2          }
 181   1          /*-------------------------------CMD B5  HORARIO mensualidad FUERA DE HORARIO --------------------------
             ---------------------------------*/
 182   1          else if ((length_trama==1)&&(*buffer==PRMR_MENSUAL_FUERA_HORARIO))                                                    /* */
 183   1          {
 184   2               PantallaLCD(MENSUAL_FUERA_HORARIO);                                                                              /*ok msj mesualidad fuera d
             -e horario*/
 185   2          }
 186   1        /*-------------------------------CMD B6 fuera de linea --------------------------------------------------
             ------------*/
 187   1          else if(*buffer==PRMR_OFF_LINE)                                                                                   /*cmd de Accescan que dice q es
             -ta fuera de linea*/
 188   1          {
 189   2              cont++;
 190   2              if (cont>4)     /* con un tiempo de retardo =((1/(22118400/12)*65535)*30)*/
 191   2              {
 192   3              PantallaLCD(OFF_LINE);
 193   3              led_err_imp=0;                                                                                                  /*error led on*/
 194   3              Timer_wait=0;
 195   3              lock=0;                                                                                                         /*relevo off despues de 1 minuto*/
 196   3              Atascado_GP0_PIN_3 = 0; 
 197   3              cont=0;
 198   3              }
 199   2          }
 200   1          /*-------------------------------CMD B7 en linea (AA) NO SE SABE  --------------------------------------
             -----------------------------*/
 201   1          else if ((*buffer==PRMR_ON_LINE)  ||(*buffer==PRMR_SOLICITA_EVN) )                                                                              
             -      /*en linea*/
 202   1          {   
 203   2            
 204   2            if (Timer_wait>=20)                                                                                               /* se envia el msj fuera de linea*/
 205   2            { 
 206   3              Timer_wait=0;                                                                                                   /*se inicia el timer*/
 207   3              lock=0;
 208   3              led_err_imp=1;                                                                                                  /*relevo off despues de 1 minuto*/
 209   3              Atascado_GP0_PIN_3 = 0; 
 210   3            } 
 211   2            
 212   2            if ((Debug_Tibbo==0)&&(USE_LPR==1)&& (Timer_tivo>=600))
 213   2            {
 214   3              Timer_tivo=0;
 215   3              Debug_Tibbo=1;
 216   3              Debug_txt_Tibbo((unsigned char *) "LIVE");
 217   3              Debug_Tibbo=0;
 218   3            }
 219   2            
C51 COMPILER V9.59.0.0   ACCESCAN                                                          06/08/2021 15:03:36 PAGE 5   

 220   2            
 221   2          } 
 222   1        /*-------------------------------CMD B8  IN_HORARIO  mensualidad vencida --------------------------------
             ---------------------------*/
 223   1          else if ((length_trama==1)&&(*buffer==PRMR_IN_HORARIO))                                                                   /* */
 224   1          {
 225   2               PantallaLCD(IN_HORARIO);                                                                                             /*mesualidad vencida*/
 226   2          }     
 227   1            /*-------------------------------CMD A1    DIREJASE_A_CAJA                ------------------------------
             -------------------------------------*/
 228   1          else if ((length_trama==1)&&(*buffer==PRMR_DIREJASE_A_CAJA  ))                                                                        /*cmd 0
             -xA1 audio caja que es igual a no registra pago */
 229   1          {
 230   2               PantallaLCD(DIREJASE_A_CAJA);
 231   2          }
 232   1          /*-------------------------------CMD 05  Lote full   ---------------------------------------------------
             ----------------*/
 233   1          else if ((length_trama==1)&&(*buffer==PRMR_LOTE_FULL))                                                                    /*lote de carros
             - full */
 234   1          {
 235   2               PantallaLCD(LOTE_FULL);
 236   2          }
 237   1            /*-------------------------------CMD 06   ACERQUE SU TARJETA DE NUEVO  --------------------------------
             -----------------------------------*/
 238   1          else if ((length_trama==1)&&(*buffer == PRMR_NOREAD_CARD  ))                                                                    /*cmd 0xA1 
             -audio caja que es igual a no registra pago */
 239   1          {
 240   2               PantallaLCD(NOREAD_CARD); //arregal ERROR_LOOP
 241   2          }
 242   1          
 243   1              /*-------------------------------CMD 07  EXCEDE_HORARIO   --------------------------------------------
             -----------------------*/
 244   1          else if ((length_trama==1)&&(*buffer==PRMR_EXCEDE_HORARIO))                                                                   /*cmd 0xA1 
             -audio caja que es igual a no registra pago */
 245   1          {
 246   2               PantallaLCD(EXCEDE_HORARIO);
 247   2          }
 248   1          
 249   1      
 250   1              /*-------------------------------CMD 08 MENSUAL_NO_PAGO   --------------------------------------------
             -----------------------*/
 251   1          else if ((length_trama == 1)&&(*buffer==PRMR_MENSUAL_NO_PAGO))                                                                    /*cmd 0x
             -A1 audio caja que es igual a no registra pago */
 252   1          {
 253   2               PantallaLCD(MENSUAL_NO_PAGO);
 254   2          } 
 255   1        
 256   1          /*-------------------------------CMD 09 UN_MOMENTO     --------------------------------------------------
             -----------------*/
 257   1          else if ((length_trama == 1)&&(*buffer==PRMR_UN_MOMENTO ))                                                                    /*cmd 0xA1 a
             -udio caja que es igual a no registra pago */
 258   1          {
 259   2               PantallaLCD(UN_MOMENTO );
 260   2          }     
 261   1        
 262   1          /*-------------------------------CMD 'V'=PRMR_GRACIAS  msj Gracias y nombre del mensual-----------------
             -------------------------*/
 263   1          else if ((length_trama == 0x13)&& (*(buffer+1)==PRMR_GRACIAS)&&*(buffer+(length_trama-1))==ETX)                 
             -        /* */
 264   1          {
 265   2               *(buffer+(length_trama-1))=0;
 266   2               PantallaLCD_LINEA_2(GRACIAS,buffer+2);                                                                     /*SE ENVIA EL MSJ GRACIAS lo
C51 COMPILER V9.59.0.0   ACCESCAN                                                          06/08/2021 15:03:36 PAGE 6   

             - q envia el software*/
 267   2          }
 268   1          
 269   1          /*-------------------------------CMD 'O'=PRMR_BIENVENIDO  msj BIENVENIDO  nombre del mensual------------
             ------------------------------*/
 270   1          else if ((length_trama == 0x13)&& (*(buffer+1) == PRMR_BIENVENIDO_MENSUAL)&&*(buffer+(length_trama-1))==
             -ETX)                          /* */
 271   1          {
 272   2             //Debug_txt_Tibbo(buffer+1);
 273   2              *(buffer+(length_trama-1))=0;
 274   2               PantallaLCD_LINEA_2(BIENVENIDO_WIEGAN,buffer+2);                                                                     /*SE ENVIA EL MSJ 
             -GRACIAS lo q envia el software*/
 275   2          }
 276   1          
 277   1          /*-------------------------------CMD de wiegand---------------------------------------------------*/
 278   1          else if ((length_trama==6)&&(*buffer==STX)&&(*(buffer+1)=='W')&&*(buffer+(length_trama-1))==ETX)                
             -    /* cmd q comunica con monitor por wiegand*/
 279   1          {
 280   2              /*-------------------------------se covierte el numero serie de la tarjeta----------------------------
             ---*/
 281   2                    ByteHex_Decimal(buff,*(buffer+2));                                                                        /*convierto el primer byte_he
             -x a decimal    */
 282   2                    buff[3]=' ';
 283   2                    Two_ByteHex_Decimal(buff+4,*(buffer+3),*(buffer+4)) ;                                                     /*convierto un byte
             - de 16 bits a decimal*/   
 284   2              /*----------------------------------------------------------------------------------------------------
             ---*/
 285   2                
 286   2            if (USE_LPR==1)
 287   2              {
 288   3                    /*-------------------------------mensaje en la pantalla -------------------------------------------
             --*/
 289   3                    /*ValidaSensoresPaso=0 no hay presencia  ValidaSensoresPaso=0xff  hay presencia*/
 290   3                    if (ValidaSensoresPaso()!= 0xff)
 291   3                    {               
 292   4                      PantallaLCD(ERROR_LOOP);
 293   4                      PantallaLCD_LINEA_2(LECTURA_WIEGAND,buff);                                                                /*msj rasberry*/
 294   4                    }
 295   3                    else
 296   3                    {
 297   4                      Cmd_LPR_Salida_wiegand(buff);
 298   4                      PantallaLCD_LINEA_2(LECTURA_WIEGAND,buff);                                                                /*msj rasberry*/
 299   4                    }
 300   3                
 301   3                                                                                                                              /*transmito el codigo de la tarjeta a la panta
             -lla lcd*/
 302   3                                
 303   3              }                                                                             
 304   2              
 305   2              else
 306   2              {
 307   3                 /*-------------------------------mensaje en la pantalla---------------------------------------------
             -------*/
 308   3                      /*modificacion 26/03/2021*/                                             
 309   3                    //if (ValidaSensoresPaso()!= 0xff)
 310   3                    //{               
 311   3                    //  PantallaLCD(ERROR_LOOP);
 312   3                    //}
 313   3                //posible falla
 314   3                    PantallaLCD_LINEA_2(LECTURA_WIEGAND,buff);                                                                /*transmito el codigo de 
             -la tarjeta a la pantalla lcd*/
 315   3                                                                                                          
C51 COMPILER V9.59.0.0   ACCESCAN                                                          06/08/2021 15:03:36 PAGE 7   

 316   3                /*---------------------------------------------------------------------------------------------------
             ------*/  
 317   3              
 318   3              }
 319   2          }
 320   1          /*-------------------------------CMD 'c' =PRMR_cupos -----------------------------------------*/
 321   1          else if  ((length_trama == 7) && (*buffer == STX)&&(*(buffer+1) == PRMR_CUPOS )&& *(buffer+(length_trama
             --1)) == ETX)  
 322   1          {
 323   2              *(buffer+(length_trama-1))=0;
 324   2               PantallaLCD_LINEA_2(CUPOS,buffer+2);   
 325   2          }
 326   1          /*numero de serie del ticket 02 , No serie 10dig,  03*/
 327   1          else if ((length_trama==12)&&(*buffer==STX)&&*(buffer+(length_trama-1))==ETX)
 328   1          {
 329   2            graba_serie(buffer+1);                                                                                          /*graba el No de concecutivo  en eep
             -rom*/
 330   2                
 331   2          }
 332   1          
 333   1      }
 334          /*------------------------------------------------------------------------------*/
 335          /*
 336          #define STX                     02 
 337          #define ETX                     03 
 338          #define FUERA_DE_LINEA          0xb6
 339          #define ON_LINE                 0xAA
 340          
 341          /*mensajes de pantalla*/
 342          /*
 343          #define BIENVENIDO              0XFE
 344          #define SIN_PAGO                0XE7
 345          #define LECTURA_DE_TARJETAS     0xB0
 346          
 347          /*tipo de vehiculo*/
 348          /*
 349          #define AUTOMOVIL           0X00
 350          #define MOTO                0X01
 351          
 352          //unsigned char S1_B2[]={0x13, 0x03, 0x1D, 0x0B, 0x0E, 00, 00, 00, 00, 00, 0x01, 0x13, 0x03, 0x1D, 0x0E, 0
             -x1D};
 353          //unsigned char S1_B0[]={0x32, 0x31, 0x30, 0x37, 0x31, 0x35, 00, 00, 00, 00, 00, 00, 00, 00, 00, 01};
 354          //unsigned char S_B[]={0xE7, 00, 00, 00, 00, 00, 00, 00, 00, 00, 01};
 355          /*------------------------------------------------------------------------------
 356          Rutina q valida los cmd del pto paralelo
 357          recibe el buffer de los datos
 358          length_trama= longitud de la trama
 359          ------------------------------------------------------------------------------*/
 360          /*
 361          void Valida_Trama_Pto(unsigned char *buffer, unsigned char length_trama)
 362          {
 363             unsigned char buff[11];
 364            /*-------------------------------CMD H reloj para el board y la pantalla lcd-----------------------------
             --------------*/
 365            //  if((length_trama==25)&&(*buffer==STX)&&(*(buffer+2)=='H')&&*(buffer+(length_trama-1))==ETX)                     
             -    /*cmd de Accescan que me envia el reloj actualizado*/
 366            //  { 
 367            //    if(validar_clk(buffer+3)==0)
 368            //    {
 369            //    Block_write_clock_ascii(buffer+3);                                                                                /* se escribe el reloj de h
             -ardware*/
 370              
C51 COMPILER V9.59.0.0   ACCESCAN                                                          06/08/2021 15:03:36 PAGE 8   

 371            //    Reloj_Pantalla_Lcd();                                                                                             /* Escribo el reloj actual  en la
             - pantalla lcd*/
 372              
 373            //    }   
 374            //  }
 375              /*-------------------------------CMD B6 fuera de linea -------------------------------------------------
             -------------*/
 376            //  else if(*buffer==FUERA_DE_LINEA)                                                                                    /*cmd de Accescan que dice q
             - esta fuera de linea*/
 377            //  {
 378            //    if (Timer_wait>=20)                                                                                               /* se envia el msj fuera de linea*
             -/
 379            //    {                                                                                                                 /* con un tiempo de retardo =((1/(22118400/
             -12)*65535)*30)*/
 380            //      PantallaLCD(FUERA_DE_LINEA);
 381            //      led_err_imp=0;                                                                                                  /*error led on*/
 382            //      //Timer_wait=0;
 383              //    lock=0;                                                                                                         /*relevo off despues de 1 minuto*/
 384              //    Atascado=0; 
 385            //    }
 386            //  }
 387              /*-------------------------------CMD AA en linea -------------------------------------------------------
             ------------*/
 388            //  else if ((*buffer==ON_LINE) )                                                                                       /*en linea*/
 389            //  {
 390                
 391            //    if (Timer_wait>=20)                                                                                               /* se envia el msj fuera de linea*
             -/
 392            //    { 
 393          //        Timer_wait=0;                                                                                                   /*se inicia el timer*/
 394          //        lock=0;
 395          //        led_err_imp=1;                                                                                                  /*relevo off despues de 1 minuto*/
 396          //        Atascado=0; 
 397          //      } 
 398                
 399          //      if ((Debug_Tibbo==0)&&(USE_LPR==1)&& (Timer_tivo>=600))
 400          //      {
 401          //        Timer_tivo=0;
 402          //        Debug_Tibbo=1;
 403            //      Debug_txt_Tibbo((unsigned char *) "LIVE");
 404          //        Debug_Tibbo=0;
 405          //      }
 406                
 407                
 408          //    } 
 409          
 410              
 411          
 412          //    else if ((length_trama==19)&&(*buffer==STX)&&(*(buffer+1)=='O')&&*(buffer+(length_trama-1))==ETX)         
             -          /*mensaje de bienvenidos*/
 413          //    {
 414           //     PantallaLCD(BIENVENIDO);
 415            //  }
 416            //  else if ((length_trama==1)&&(*buffer==0xA1))                                                                        /*cmd 0xA1 audio caja 
             -que es igual a no registra pago */
 417            //  {
 418            //       PantallaLCD(SIN_PAGO);
 419            //  }
 420                        /*-------------------------------CMD de wiegand---------------------------------------------------*
             -/
 421          //    else if ((length_trama==6)&&(*buffer==STX)&&(*(buffer+1)=='W')&&*(buffer+(length_trama-1))==ETX)            
             -        /* cmd q comunica con monitor po wigan*/
C51 COMPILER V9.59.0.0   ACCESCAN                                                          06/08/2021 15:03:36 PAGE 9   

 422          //    {
 423          //        if (USE_LPR==1)
 424          //        {
 425                        /*-------------------------------mensaje en la pantalla--------------------------------------------
             --------*/
 426            //            ByteHex_Decimal(buff,*(buffer+2));                                                                        /*convierto el primer byte_
             -hex a decimal    */
 427              //          buff[3]=' ';
 428              //          Two_ByteHex_Decimal(buff+4,*(buffer+3),*(buffer+4)) ;                                                     /*convierto un by
             -te de 16 bits a decimal*/                                                 
 429                      
 430              //          PantallaLCD_LINEA_2(LECTURA_DE_TARJETAS,buff);
 431                                                                                                                                  /*transmito el codigo de la tarjeta a la panta
             -lla lcd*/
 432                        /*-------------------------------------------------------------------------------------------------
             --------*/
 433                    
 434                //        while(!ValidaSensoresPaso());
 435                          
 436              //          Cmd_LPR_Salida_wiegand(buff);
 437              //    }                                                                             
 438                  
 439              //    else
 440              //    {
 441                     /*-------------------------------mensaje en la pantalla---------------------------------------------
             -------*/
 442              //          ByteHex_Decimal(buff,*(buffer+2));                                                                        /*convierto el primer byte_
             -hex a decimal    */
 443              //          buff[3]=' ';
 444              //          Two_ByteHex_Decimal(buff+4,*(buffer+3),*(buffer+4)) ;                                                     /*convierto un by
             -te de 16 bits a decimal*/                                                 
 445              //          PantallaLCD_LINEA_2(LECTURA_DE_TARJETAS,buff);                                                            /*transmito el codigo
             - de la tarjeta a la pantalla lcd*/
 446                                                                                                              
 447                    /*---------------------------------------------------------------------------------------------------
             ------*/  
 448                  
 449              //    }
 450            //  }
 451              /*numero de serie del ticket 02 , No serie 10dig,  03*/
 452            //  else if ((length_trama==12)&&(*buffer==STX)&&*(buffer+(length_trama-1))==ETX)
 453            //  {
 454            //    graba_serie(buffer+1);                                                                                          /*graba el No de concecutivo  en e
             -eprom*/
 455                    
 456            //  }
 457          //}
 458          
 459          /*------------------------------------------------------------------------------
 460          Rutina q valida los cmd de Monitor
 461          ------------------------------------------------------------------------------*/
 462          /*
 463          void Valida_Trama_Monitor(unsigned char *buffer, unsigned char length_trama)
 464          {   
 465            length_trama=1;
 466              if  ((*(buffer+2)==ETX)&&(*(buffer+1)=='P'))                                                                            /* APERTURA DE BARRETA
             -*/ 
 467          /*        {
 468                    lock=1;                                                                                                           /*habilita el relevo ON*/
 469          //          Timer_wait=0;
 470          //        }
 471          //    else if (*buffer=='<')
C51 COMPILER V9.59.0.0   ACCESCAN                                                          06/08/2021 15:03:36 PAGE 10  

 472          //    {                                                                                                                       /*placa*/
 473          //    }
 474          //}
 475          /*------------------------------------------------------------------------------
 476          
 477          ------------------------------------------------------------------------------*/
 478          /*
 479          void Cmd_Monitor()
 480          {
 481              
 482            
 483          }
 484          */
 485          /*------------------------------------------------------------------------------
 486          Transmito un caracter al software monitor 
 487          ------------------------------------------------------------------------------*/
 488          void Monitor_chr (unsigned char *str,unsigned char num_char)
 489          {
 490   1        unsigned char j;
 491   1        for (j=0; j<num_char; j++)
 492   1          {
 493   2          tx_aux(*str);
 494   2          str++;
 495   2          }
 496   1      }
 497            
 498          /*------------------------------------------------------------------------------
 499          Transmito CMD de salida wiegand 
 500          ------------------------------------------------------------------------------*/
 501          void Cmd_LPR_Salida_wiegand(unsigned char *buffer)
 502          {
 503   1        unsigned char Buffer_Lpr[30];
 504   1        unsigned char j=3;
 505   1        Buffer_Lpr[0]=STX;                                      /*inicio de cmd STx*/
 506   1        Buffer_Lpr[1]=Dir_board();                              /*direccion de la tarjeta*/
 507   1        Buffer_Lpr[2]='S';                                      /*cmd S que salida wiegand*/
 508   1        if(Tipo_Vehiculo!=0)                                    /*Tipo de vehiculo*/
 509   1          {
 510   2            Buffer_Lpr[j++]='M';                                /*moto*/
 511   2          }
 512   1          else
 513   1          {
 514   2            Buffer_Lpr[j++]='C';                                /*carro*/
 515   2          }
 516   1        
 517   1          
 518   1          
 519   1          for (j=4; *buffer != '\0'; j++)                       /*numero del tab o tarjeta Mf*/
 520   1            {
 521   2                Buffer_Lpr[j]=*buffer;
 522   2                buffer++;
 523   2              
 524   2            }
 525   1            Buffer_Lpr[j++]=':';                                /*separador del tab  o tarjeta MF*/
 526   1                        
 527   1            Block_read_clock_ascii(Buffer_Lpr+j);               /*año,mes,dia,hora,minutos,*/
 528   1            Buffer_Lpr[j+10]=':';                               /*separador fecha*/
 529   1            Buffer_Lpr[j+11]=ETX;                               /*fin de la trama*/
 530   1          
 531   1                
 532   1          
 533   1            Monitor_chr(Buffer_Lpr,j+12);                       /*rutina de envio de la trama a monitor*/
C51 COMPILER V9.59.0.0   ACCESCAN                                                          06/08/2021 15:03:36 PAGE 11  

 534   1      }
 535          unsigned char Calculo_bcc(unsigned char *buffer, unsigned char leng_trama)
 536          {
 537   1        unsigned char bcc=0;
 538   1        unsigned char j;
 539   1        
 540   1        for (j=0; j<leng_trama; j++)
 541   1        {
 542   2              bcc=*(buffer+j) ^ bcc;
 543   2        }
 544   1        return bcc;
 545   1      }
 546          /*------------------------------------------------------------------------------
 547          
 548          ------------------------------------------------------------------------------*/
 549          //void Cmd_LPR_Salida(unsigned char *buffer_S1_B0,unsigned char *buffer_S1_B2)
 550          //{
 551            
 552            
 553          //  unsigned char Buffer_Lpr[30];
 554          //  unsigned temp;
 555          //  unsigned char j=3;
 556          //  Buffer_Lpr[0]=STX;                                /*inicio de cmd STx*/
 557          //  Buffer_Lpr[1]=Dir_board();                        /*direccion de la tarjeta*/
 558          //  Buffer_Lpr[2]='S';                                /*numero de digitos de transmicion NO IMPORTA NO ES VALIDADO EN PRINC
             -IPAL*/
 559            
 560          //    if(*(buffer_S1_B2+8)!=0)                        /*Tipo de vehiculo*/
 561          //    {
 562            //    Buffer_Lpr[j++]='M';                          /*moto*/
 563            //  }
 564            //  else
 565            //  {
 566            //    Buffer_Lpr[j++]='C';                          /*carro*/
 567            //  }
 568            
 569            
 570          //  do
 571            //{
 572            // Buffer_Lpr[j++]=*buffer_S1_B0;                 /*ticket o consecutivo*/
 573            //  buffer_S1_B0++;
 574            //}while (*buffer_S1_B0!=0);
 575            
 576            
 577            
 578            
 579            
 580              //Buffer_Lpr[j++]=':';                            /*separador de la fecha de entrada*/
 581          
 582            //  temp=hex_bcd(*(buffer_S1_B2+0));                /*año a ascii*/
 583            //  Buffer_Lpr[j++]=((temp & 0xf0)>>4)| 0x30;
 584            //  Buffer_Lpr[j++]=((temp & 0x0f))| 0x30;
 585              
 586            //  temp=hex_bcd(*(buffer_S1_B2+1));                /*mes a ascii*/
 587            //  Buffer_Lpr[j++]=((temp & 0xf0)>>4)| 0x30;
 588            //  Buffer_Lpr[j++]=((temp & 0x0f))| 0x30;
 589            
 590            //  temp=hex_bcd(*(buffer_S1_B2+2));                /*Dia a ascii*/
 591            //  Buffer_Lpr[j++]=((temp & 0xf0)>>4)| 0x30;
 592            //  Buffer_Lpr[j++]=((temp & 0x0f))| 0x30;
 593            
 594            //  temp=hex_bcd(*(buffer_S1_B2+3));                /*Hora a ascii*/
C51 COMPILER V9.59.0.0   ACCESCAN                                                          06/08/2021 15:03:36 PAGE 12  

 595            //  Buffer_Lpr[j++]=((temp & 0xf0)>>4)| 0x30;
 596            //  Buffer_Lpr[j++]=((temp & 0x0f))| 0x30;
 597            
 598            //  temp=hex_bcd(*(buffer_S1_B2+4));                /*Minutos a ascii*/
 599            //  Buffer_Lpr[j++]=((temp & 0xf0)>>4)| 0x30;
 600            //  Buffer_Lpr[j++]=((temp & 0x0f))| 0x30;
 601            
 602              
 603            
 604            //  Buffer_Lpr[j++]=':';                            /*separador tipo fecha*/
 605                                                              /**/
 606                  
 607            //  Buffer_Lpr[j++]=ETX;  
 608            
 609            //  Monitor_chr(Buffer_Lpr,j);                        /*rutina de envio de la trama a monitor*/
 610          //}
 611          //void Cmd_Lpr_Int()
 612          //{
 613          //  unsigned char Buffer_Lpr[30];
 614          //  unsigned char j=3;
 615          //  unsigned char *ticket;/
 616          //  Buffer_Lpr[0]=STX;                                /*inicio de cmd STx*/
 617          //  Buffer_Lpr[1]=Dir_board();                        /*direccion de la tarjeta*/
 618          //  Buffer_Lpr[2]='E';                                /*numero de digitos de transmicion NO IMPORTA NO ES VALIDADO EN PRINC
             -IPAL*/
 619          //  if (Tipo_Vehiculo==AUTOMOVIL)         //cambio del vehiculo
 620          //  {
 621          //    Buffer_Lpr[3]='C';
 622          //    Buffer_Lpr[4]=0;
 623          //  }
 624          //  else
 625          //    {
 626          //      Buffer_Lpr[3]=('M');
 627          //      Buffer_Lpr[4]=0;
 628          //    }
 629          //    
 630          //  ticket=Lee_No_Ticket();
 631          //  strcpy( Buffer_Lpr,ticket);
 632          //}
 633          
 634            


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1604    ----
   CONSTANT SIZE    =     59    ----
   XDATA SIZE       =      1      63
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
