C51 COMPILER V9.59.0.0   PANTALLAS                                                         07/14/2020 08:20:39 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE PANTALLAS
OBJECT MODULE PLACED IN .\Objects\pantallas.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE pantallas.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Li
                    -stings\pantallas.lst) TABS(2) OBJECT(.\Objects\pantallas.obj)

line level    source

   1          #include<pantallas.h>
   2          #include <reg51.h>
   3          #include <string.h>
   4          
   5          sbit sel_com = P0^7;        //Micro switch    
   6          
   7          
   8          /*funciones externas*/
   9          extern char putchar (char c);
  10          extern void Block_read_Clock(unsigned char *datos_clock);
  11          extern void DebugBufferMF(unsigned char *str,unsigned char num_char,char io);
  12          extern void Debug_Dividir_texto();
  13          extern void clean_tx();
  14          extern void Debug_txt_Tibbo(unsigned char * str);
  15          extern void          _nop_     (void);
  16          extern void Debug_chr_Tibbo(unsigned char Dat);
  17          
  18          #define ERROR_LOOP              0XE0
  19          #define TARJETA_INVALIDA        0XE1
  20          #define TARJETA_SIN_FORMATO     0xDF
  21          #define ERROR_COD_PARK          0XE5
  22          #define SIN_INGRESO             0XE6
  23          #define SIN_PAGO                0XE7
  24          #define EXCEDE_GRACIA           0XE8
  25          #define SIN_SALIDA              0XE9
  26          #define FUERA_DE_LINEA          0XB6
  27          #define LECTURA_DE_TARJETAS     0xB0
  28          
  29          
  30          #define AUDIO_CAJA        0XA1
  31          #define TARJETA_VENCIDA     0XEC
  32          #define TARJETA_ATASCADA    0XEF
  33          
  34          
  35          #define ERROR_TIPO_VEHICULO     0XF8
  36          #define BIENVENIDO              0XFE
  37          #define GRACIAS                 0XFF
  38          
  39          #define NOTIFIQUE_EVP           'N'
  40          #define NO_NOTIFIQUE_EVP        'S'
  41          #define COMPARANDO_PLACA        'P'           /*msj de eeror de placa*/
  42          #define ENVIANDO_COD            'D'
  43          #define INFO1                   'I'
  44          #define INFO2                   'i'
  45          
  46          /*variables externas */
  47          extern unsigned char  Raspberry;
  48          /*------------------------------------------------------------------------------
  49          transmite el caracter pto serie
  50          data_com = al caracter a escribir
  51          enable_char_add = si esta en (1) envia un null (0) adicional, si es (0) no envia caracter adicional
  52          ------------------------------------------------------------------------------*/
  53          void tx_chrlcd (unsigned char data_com, unsigned char enable_char_add)
  54          {
C51 COMPILER V9.59.0.0   PANTALLAS                                                         07/14/2020 08:20:39 PAGE 2   

  55   1        unsigned char d;
  56   1        d=putchar(data_com);
  57   1        if (enable_char_add != 0) d=putchar(0x00);
  58   1        
  59   1      }
  60          
  61          /*------------------------------------------------------------------------------
  62          envia un msj asta null(0)
  63          msg= apuntador del msj
  64          enable_char_add = si esta en (1) envia un null (0) adicional, si es (0) no envia caracter adicional
  65          ------------------------------------------------------------------------------*/
  66          void LCD_txt (unsigned char * msg,unsigned char enable_char_add )
  67          {
  68   1        unsigned char i;
  69   1         
  70   1        for (i=0; msg[i] != '\0'; i++)
  71   1        {
  72   2          tx_chrlcd(msg[i],enable_char_add);
  73   2        }
  74   1      }
  75          /*------------------------------------------------------------------------------
  76          Escribo el reloj en ascii en bloque 
  77          msg= apuntador del msj
  78          length_char longitud de la tram
  79          enable_char_add = si esta en (1) envia un null (0) adicional, si es (0) no envia caracter adicional
  80          ------------------------------------------------------------------------------*/
  81          void LCD_txt_num_char(unsigned char * msg,unsigned char length_char, unsigned char enable_char_add)
  82          {
  83   1        unsigned char i;
  84   1         
  85   1        for (i=0; i<length_char; i++)
  86   1        {
  87   2          tx_chrlcd(msg[i],enable_char_add);
  88   2        }
  89   1      }
  90          /*------------------------------------------------------------------------------
  91          Transmite una trama por el pto serie con el protocolo para  raspberry
  92          msg= es el apuntador del msj
  93          ------------------------------------------------------------------------------*/
  94          void Raspberry_data (unsigned char * msg)
  95          {
  96   1        static unsigned char i;
  97   1        unsigned char lenth_cadena;
  98   1        unsigned char d;
  99   1        
 100   1        lenth_cadena=strlen(msg);
 101   1        Debug_chr_Tibbo(lenth_cadena);
 102   1        Debug_Dividir_texto();  
 103   1        Debug_txt_Tibbo(msg); 
 104   1        Debug_Dividir_texto();    
 105   1        for (i=0;  i<lenth_cadena+1 ; i++)
 106   1        {
 107   2          d=putchar(*msg);
 108   2          msg++;
 109   2        
 110   2        
 111   2         
 112   2        }
 113   1        
 114   1        
 115   1        
 116   1      }
C51 COMPILER V9.59.0.0   PANTALLAS                                                         07/14/2020 08:20:39 PAGE 3   

 117          
 118          
 119          /*------------------------------------------------------------------------------
 120          Escribo el reloj en ascii en bloque 
 121          AA 80 28 trama de inicio de configuracion de la pantalla
 122          07 numero de caracteres de la trama de reloj
 123          20 19 03 26 09 21 20  el dato del reloj
 124          ------------------------------------------------------------------------------*/
 125          void Reloj_Pantalla_Lcd()
 126          {
 127   1      
 128   1       unsigned char Ini_Clock_LCD   []={0xaa,0x80,0x28,0x07,0x20,0x00,0,0,0,0,20,0,0} ;
 129   1                if (Raspberry==0)
 130   1                { 
 131   2                sel_com=0;                                                                      /*switch del pto serie a la pantalla*/
 132   2                Block_read_Clock(Ini_Clock_LCD+5);                                              /*Leo el reloj programado*/
 133   2                //Debug_Dividir_texto();                                                          /*lineas de separacion del texto*/
 134   2                //DebugBufferMF(Ini_Clock_LCD,12,0);                                              /*muestra la trama por debug*/
 135   2                //Debug_Dividir_texto();                                                          /*linea de separacion de texto*/
 136   2                REN = 0;                                                                        /*inhabilita recepcion de datos*/
 137   2                LCD_txt_num_char(Ini_Clock_LCD,13,0);                                           /*cmd de inicializacion del reloj del lcd*
             -/
 138   2                                                            
 139   2                REN = 1;                                                                        /*habilita recepcion de datos*/
 140   2                sel_com=1;  
 141   2                  /*switch pto serie a verificador o expedidor */
 142   2                }
 143   1                else
 144   1                {
 145   2                  sel_com=0;
 146   2                  Ini_Clock_LCD [0]=0;
 147   2                  Block_read_Clock(Ini_Clock_LCD);
 148   2                  Raspberry_data((unsigned char  *) "d;hora");
 149   2                  sel_com=1;  
 150   2                }
 151   1      }
 152          /*------------------------------------------------------------------------------
 153          Rutina de msj de pantalla
 154          ------------------------------------------------------------------------------*/
 155          void PantallaLCD(unsigned char cod_msg)
 156          {
 157   1      
 158   1      unsigned char Ini_LCD_Line_one   []={0xaa,0x80,0x18,0x01,0x02,0x00} ;
 159   1      //unsigned char Ini_LCD_Line_two   []={0xaa,0x80,0x18,0x02,0x02,0x00} ;
 160   1      //unsigned char Ini_Off_Line []={0xaa,0x80,0x18,0x01,0x03,0x00} ;
 161   1        
 162   1      unsigned char num_chr;
 163   1      
 164   1        
 165   1          sel_com=0;
 166   1        
 167   1          if (Raspberry==0)
 168   1          {
 169   2            LCD_txt (Ini_LCD_Line_one,0);
 170   2            
 171   2            switch (cod_msg)
 172   2            {
 173   3          
 174   3              case 'P':
 175   3                
 176   3                num_chr=strlen((unsigned char  *) "ERROR: VALIDANDO PLACA... ");
 177   3                tx_chrlcd(0x00,0);
C51 COMPILER V9.59.0.0   PANTALLAS                                                         07/14/2020 08:20:39 PAGE 4   

 178   3                tx_chrlcd(num_chr*2,0);
 179   3                LCD_txt ((unsigned char *)       "ERROR: VALIDANDO PLACA... ",1);
 180   3                
 181   3                break;
 182   3      
 183   3              case ERROR_LOOP:
 184   3                
 185   3                num_chr=strlen((unsigned char *) "ERROR: LOOP1 SIN PRESENCIA VEHICULAR ");  
 186   3                tx_chrlcd(0x00,0);
 187   3                tx_chrlcd(num_chr*2,0);
 188   3                LCD_txt ((unsigned char *)       "ERROR: LOOP1 SIN PRESENCIA VEHICULAR ",1);
 189   3                
 190   3                break;
 191   3              
 192   3              case TARJETA_INVALIDA:
 193   3                
 194   3                num_chr=strlen((unsigned char *) "ERROR: TARJETA INVALIDA "); 
 195   3                tx_chrlcd(0x00,0);
 196   3                tx_chrlcd(num_chr*2,0);
 197   3                LCD_txt ((unsigned char *)       "ERROR: TARJETA INVALIDA ",1);
 198   3                
 199   3                break;
 200   3              
 201   3              case ERROR_COD_PARK:
 202   3          
 203   3                num_chr=strlen((unsigned char *) "TARJETA NO ES DEL PARQ. ");
 204   3                tx_chrlcd(0x00,0);
 205   3                tx_chrlcd(num_chr*2,0);
 206   3                LCD_txt ((unsigned char *)       "TARJETA NO ES DEL PARQ. ",1);
 207   3          
 208   3                break;
 209   3                
 210   3              case TARJETA_SIN_FORMATO:
 211   3          
 212   3                num_chr=strlen((unsigned char *) "TARJETA SIN FORMATO ");
 213   3                tx_chrlcd(0x00,0);
 214   3                tx_chrlcd(num_chr*2,0);
 215   3                LCD_txt((unsigned char *)        "TARJETA SIN FORMATO ",1);
 216   3      
 217   3                break;
 218   3                
 219   3              case SIN_PAGO:
 220   3          
 221   3                num_chr=strlen((unsigned char  *) "TARJETA NO REGISTRA PAGO ");
 222   3                tx_chrlcd(0x00,0);
 223   3                tx_chrlcd(num_chr*2,0);
 224   3                LCD_txt ((unsigned char *)       "TARJETA NO REGISTRA PAGO ",1);
 225   3      
 226   3                break;
 227   3                  
 228   3              case EXCEDE_GRACIA:
 229   3          
 230   3                num_chr=strlen((unsigned char  *) "EXCEDE TIEMPO DE GRACIA ");
 231   3                tx_chrlcd(0x00,0);
 232   3                tx_chrlcd(num_chr*2,0);
 233   3                LCD_txt ((unsigned char *)       "EXCEDE TIEMPO DE GRACIA ",1);
 234   3            
 235   3                break;
 236   3              
 237   3              case  FUERA_DE_LINEA:
 238   3                
 239   3                num_chr=strlen((unsigned char *) "FUERA DE LINEA ");
C51 COMPILER V9.59.0.0   PANTALLAS                                                         07/14/2020 08:20:39 PAGE 5   

 240   3                tx_chrlcd(0x00,0);
 241   3                tx_chrlcd(num_chr*2,0);
 242   3                LCD_txt((unsigned char *)        "FUERA DE LINEA ",1);
 243   3              
 244   3                break;
 245   3              
 246   3              case  BIENVENIDO:
 247   3                
 248   3                num_chr=strlen((unsigned char *) "BIENVENIDO ");
 249   3                tx_chrlcd(0x00,0);
 250   3                tx_chrlcd(num_chr*2,0);
 251   3                LCD_txt((unsigned char *)        "BIENVENIDO ",1);
 252   3                
 253   3                break;
 254   3              
 255   3              case  SIN_INGRESO:
 256   3                
 257   3                num_chr=strlen((unsigned char *) "ERROR: SIN INGRESO ");
 258   3                tx_chrlcd(0x00,0);
 259   3                tx_chrlcd(num_chr*2,0);
 260   3                LCD_txt((unsigned char *)        "ERROR: SIN INGRESO ",1);
 261   3                
 262   3                break;
 263   3                      
 264   3            }
 265   2              sel_com=1;  
 266   2        
 267   2          }
 268   1            else
 269   1            {
 270   2               sel_com=0;   
 271   2               switch (cod_msg)
 272   2               {
 273   3            
 274   3                  case 'P':
 275   3                          
 276   3                       
 277   3                        Raspberry_data((unsigned char  *) "a;98;ERROR VALIDANDO PLACA \n\r\0");
 278   3                        break;
 279   3                  case AUDIO_CAJA:
 280   3                        
 281   3                        Raspberry_data((unsigned char  *) "a;27;¡ NO REGISTRA PAGO ! \n\r\0");
 282   3                        break;
 283   3                  case ERROR_LOOP:
 284   3                     
 285   3                        Raspberry_data((unsigned char  *) "a;98;SIN PRESENCIA VEHICULAR \n\r\0");
 286   3                        break;
 287   3                  case TARJETA_INVALIDA:
 288   3                     
 289   3                        Raspberry_data((unsigned char  *) "a;98;TARJETA INVALIDA \n\r\0");
 290   3                        
 291   3                        break;
 292   3                  case 0xe2:
 293   3      
 294   3                        Raspberry_data((unsigned char  *) "a;98;ERROR: ANTICOLL \n\r\0");
 295   3                        break;
 296   3                  case 0xe3:
 297   3      
 298   3                        Raspberry_data((unsigned char  *) "a;98;ERROR: SELECT CARD \n\r\0");
 299   3                        break;
 300   3                  case 0xe4:
 301   3                      
C51 COMPILER V9.59.0.0   PANTALLAS                                                         07/14/2020 08:20:39 PAGE 6   

 302   3                        Raspberry_data((unsigned char  *) "a;98;TARJETA INVALIDA \n\r\0");
 303   3                        break;
 304   3                  case ERROR_COD_PARK:
 305   3                       
 306   3                        Raspberry_data((unsigned char  *) "a;98;CARD NO ES DE PARQUEADERO \n\r\0");
 307   3                        break;
 308   3                  
 309   3                  case SIN_INGRESO:
 310   3                     
 311   3                        Raspberry_data((unsigned char  *) "a;30;TARJETA SIN INGRESO \n\r\0");
 312   3                        break;
 313   3                  case SIN_PAGO:
 314   3                     
 315   3                        Raspberry_data((unsigned char  *) "a;27;TARJETA NO REGISTRA PAGO\n\r\0");
 316   3                        break;
 317   3                  case EXCEDE_GRACIA:
 318   3                      
 319   3                        Raspberry_data((unsigned char  *) "a;28;EXCEDE TIEMPO DE GRACIA \n\r\0");
 320   3                        break;
 321   3                 
 322   3                  case 0xeb:
 323   3                      
 324   3                        Raspberry_data((unsigned char  *) "a;27;DIRIJASE A CAJA \n\r\0");
 325   3                        break;
 326   3                  case TARJETA_VENCIDA:
 327   3                     //   Raspberry_txt((unsigned char  *) "a;07;");
 328   3                        Raspberry_data((unsigned char  *) "a;07;MENSUALIDAD VENCIDA !   ");
 329   3                        Raspberry_data((unsigned char  *) "  VENCIO : 20");
 330   3                  
 331   3               // falta la parte alta del vencimiento
 332   3                        break;
 333   3                  case 0xed:
 334   3                      
 335   3                        Raspberry_data((unsigned char  *) "a;98;SIN RESPUESTA \n\r\0");
 336   3                        break;
 337   3                  case TARJETA_ATASCADA:
 338   3                       
 339   3                        Raspberry_data((unsigned char  *) "TARJETA ATASCADA \n\r\0");
 340   3                        break;
 341   3                  case 0xf8:
 342   3                        
 343   3                       
 344   3                        Raspberry_data((unsigned char  *) "a;98;SALIDA INVALIDA \n\r\0");
 345   3                        break;
 346   3                  case GRACIAS:
 347   3                       
 348   3                        Raspberry_data((unsigned char  *) "a;26;GRACIAS... \n\r\0");
 349   3                        break;
 350   3                  
 351   3                  case  FUERA_DE_LINEA:
 352   3                    Raspberry_data((unsigned char  *) "a;99;FUERA DE LINEA\n\r\0");
 353   3                        break;
 354   3                  case  '0':    /*Bienvenido.pulse el boton*/
 355   3                  Raspberry_data((unsigned char  *) "a;00;BIENVENIDO. PULSE EL BOTON\n\r\0");
 356   3                        break;
 357   3                  case  '9':    /*NO olvide pasar por el punto de pago*/
 358   3                  Raspberry_data((unsigned char  *) "a;99;NO OLVIDE PASAR POR EL PUNTO DE PAGO\n\r\0");
 359   3                        break;
 360   3                  case  'X':    /*Bienvenido*/
 361   3                  Raspberry_data((unsigned char  *) "a;99;BIENVENIDO\n\r\0");
 362   3                        break;
 363   3                  case  'C':    /*Mensualidad cancelada*/
C51 COMPILER V9.59.0.0   PANTALLAS                                                         07/14/2020 08:20:39 PAGE 7   

 364   3                  Raspberry_data((unsigned char  *) "a;97;MENSUALIDAD CANCELADA ... DIRIJASE A ADMINISTRACION\n\
             -r\0");
 365   3                        break;
 366   3                  case  'a':    /*Mensualidad cancelada*/
 367   3                  Raspberry_data((unsigned char  *) "a;99;NIVEL BAJO DE TARJETAS\n\r\0");
 368   3                        break;
 369   3                  case  SIN_SALIDA:   /*Mensualidad cancelada*/
 370   3                  Raspberry_data((unsigned char  *) "a;99;SIN SALIDA\n\r\0");
 371   3                        break;
 372   3                  
 373   3                  
 374   3               }
 375   2               sel_com=1;   
 376   2            }
 377   1            
 378   1           
 379   1      
 380   1      }
 381          void PantallaLCD_LINEA_2(unsigned char cod_msg, unsigned char *buffer)
 382          {
 383   1        
 384   1      unsigned char Ini_LCD_Line_one   []={0xaa,0x80,0x18,0x01,0x02,0x00} ;
 385   1      
 386   1      
 387   1      unsigned char num_chr;
 388   1        
 389   1      sel_com=0;
 390   1        
 391   1          //if (Raspberry==0)
 392   1          //{
 393   1          
 394   1            
 395   1            switch (cod_msg)
 396   1            {
 397   2          
 398   2              case  LECTURA_DE_TARJETAS:
 399   2                LCD_txt (Ini_LCD_Line_one,0);
 400   2                num_chr=strlen((unsigned char *) "WIEGAND ");
 401   2                num_chr=num_chr+strlen(buffer)+1;
 402   2                tx_chrlcd(0x00,0);
 403   2                tx_chrlcd(num_chr*2,0);
 404   2                LCD_txt((unsigned char *)        "WIEGAND ",1);                       /*funcion q trasmite el msj al LCD  y el 
             -(1) coloca los caracteres NULL*/
 405   2                LCD_txt(buffer,1);                                                    /*funcion q trasmite el msj al LCD  y el (1) coloca los 
             -caracteres NULL*/
 406   2                
 407   2              
 408   2              
 409   2              
 410   2                break;
 411   2              
 412   2              
 413   2        }
 414   1              sel_com=1;  
 415   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1199    ----
   CONSTANT SIZE    =    969    ----
   XDATA SIZE       =      1      50
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.59.0.0   PANTALLAS                                                         07/14/2020 08:20:39 PAGE 8   

   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
